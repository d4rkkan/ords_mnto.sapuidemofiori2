sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/demo/fiori2/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,s,o){"use strict";return t.extend("sap.ui.demo.fiori2.controller.DetailDetail",{onInit:function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oModel=e.getModel();this.oRouter.getRoute("detailDetail").attachPatternMatched(this._onPatternMatch,this)},_onPatternMatch:function(e){sap.ui.core.BusyIndicator.show(0);var t=this.getView().byId("ictBar");t.setSelectedKey("Op");this._orden=e.getParameter("arguments").orden||this._supplier||"0";this._operacion=e.getParameter("arguments").operacion||this._product||"0";this.getOperationsData(this._orden,this._operacion);var o=this.getView();o.setBusy(true);var a=this.getOwnerComponent().getModel("ModelOrdenes");var i=a.sServiceUrl;var r=new sap.ui.model.odata.ODataModel(i,true);var n="/RepuestosSet?$filter=IdOrden eq '"+this._orden+"' and IdOperacion eq '"+this._operacion+"' ";var u=this.fnReadEntity(r,n);if(u.tipo==="S"){this.oDataRepuestos=u.datos.results}else{s.error(u.msjs,null,"Mensaje del sistema","OK",null)}var c="";if(!c){c={lstItemsRepuestos:[]}}c.lstItemsRepuestos=this.oDataRepuestos;var d=this.byId("repuestosTable");var h=new sap.ui.model.json.JSONModel(c);d.setModel(h);d.getBinding("items").refresh();o.setBusy(false)},getOperationsData:function(e,t){var s=this.getView().getModel("ModelOrdenes");var o=s.createKey("/OperacionesSet",{IdOrden:e,IdOperacion:t});s.read(o,{success:jQuery.proxy(this.mapOperationData,this),error:jQuery.proxy(this.onError,this)})},mapOperationData:function(t,s){var o=new e(t);this.getView().setModel(o,"detOperation");sap.ui.core.BusyIndicator.hide()},onError:function(e){sap.ui.core.BusyIndicator.hide()},onPressGuardarRepuestos:function(e){var t="";var o=this.getView().byId("ictBar").getSelectedKey();if(o==="Op"){t="Esta seguro que desea guardar los tiempos de las operaciones?"}else{t="Esta seguro que desea guardar la información de repuestos ?"}var a=!!this.getView().$().closest(".sapUiSizeCompact").length;s.confirm(t,{styleClass:a?"sapUiSizeCompact":"",onClose:function(e){if(e===s.Action.OK){sap.ui.core.BusyIndicator.show(0);if(o==="Op"){this.saveOperationDetail()}else{this.saveRepuestos()}}}.bind(this)})},saveRepuestos:function(){var e=this.getView().byId("repuestosTable");var t=e.getSelectedItems();var o=false;var a=this.getView().getModel("ModelOrdenes");if(!t.length){var i=!!this.getView().$().closest(".sapUiSizeCompact").length;s.confirm("Por favor seleccione por lo menos un repuesto",{styleClass:i?"sapUiSizeCompact":"",onClose:function(e){if(e===s.Action.OK){sap.ui.core.BusyIndicator.hide()}}.bind(this)})}for(var r=0;r<t.length;r++){var n=t[r].getBindingContext().getObject();if(r+1===t.length){o=true}a.create("/RepuestosSet",n,{success:jQuery.proxy(this.successSaveRep,this,o),error:jQuery.proxy(this.onError,this)})}},successSaveRep:function(e,t,s){if(e){sap.ui.core.BusyIndicator.hide();o.show("Se han guardado la información de repuestos exitosamente");this.onNavBack()}},saveOperationDetail:function(){var e=this.getView();var t=e.getModel("ModelOrdenes");var s=e.getModel("detOperation");var o=s.getProperty("/");t.create("/OperacionesSet",o,{success:jQuery.proxy(this.successSaveOp,this),error:jQuery.proxy(this.onError,this)})},successSaveOp:function(e,t){sap.ui.core.BusyIndicator.hide();o.show("Se han guardado las operaciones exitosamente");this.onNavBack()},handleLiveChange:function(e){var t=e.getSource(),s=t.getValue().length,o=t.getMaxLength(),a=s>o?"Warning":"None";t.setValueState(a)},onExit:function(){this.oRouter.getRoute("detailDetail").detachPatternMatched(this._onPatternMatch,this)}})});