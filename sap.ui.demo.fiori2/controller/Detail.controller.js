sap.ui.define(["sap/ui/demo/fiori2/controller/BaseController","sap/f/library","sap/ndc/BarcodeScanner","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/m/MessageToast"],function(e,t,o,s,a,r){"use strict";return e.extend("sap.ui.demo.fiori2.controller.Detail",{onInit:function(){var e=this.getOwnerComponent();var t=new a({Qr:false});this.getView().setModel(t,"Qr");this.oRouter=e.getRouter();this.oModel=e.getModel();this.oRouter.getRoute("detail").attachPatternMatched(this._onOrderMatched,this)},_onOrderMatched:function(e){sap.ui.core.BusyIndicator.show(0);this._orden=e.getParameter("arguments").orden||this._orden||"0";this.getDataByOrder(this._orden);var t=this.getView();t.setBusy(true);var o=this.getOwnerComponent().getModel("ModelOrdenes");var a=o.sServiceUrl;var r=new sap.ui.model.odata.ODataModel(a,true);var i="/OperacionesSet?$filter=IdOrden eq '"+this._orden+"'";var n=this.fnReadEntity(r,i);if(n.tipo==="S"){this.oDataOperaciones=n.datos.results}else{s.error(n.msjs,null,"Mensaje del sistema","OK",null)}var d="";if(!d){d={lstItemsOperaciones:[]}}d.lstItemsOperaciones=this.oDataOperaciones;var c=this.byId("operacionesTable");var l=new sap.ui.model.json.JSONModel(d);c.setModel(l);var u=this.getView().byId("ictbFilterOp");u.setCount(d.lstItemsOperaciones.length);c.getBinding("items").refresh();t.setBusy(false)},closeOrder:function(){var e=true;var t=!!this.getView().$().closest(".sapUiSizeCompact").length;s.confirm("Esta seguro que desea cerrar la orden?",{styleClass:t?"sapUiSizeCompact":"",onClose:function(o){if(o===s.Action.OK){var a=this.getView().byId("operacionesTable").getItems();for(var r=0;r<a.length;r++){var i=a[r].getBindingContext().getObject();if(!i.CompOp||!i.CompRep){e=false}}if(e){this.onNavBack()}else{s.confirm("Aun no se han completado las operaciones de la orden",{styleClass:t?"sapUiSizeCompact":"",onClose:function(e){}.bind(this)})}}}.bind(this)})},getDataByOrder:function(e){var t=this.getView().getModel("ModelOrdenes");var o=t.createKey("/OrdenesSet",{IdOrden:e});t.read(o,{success:jQuery.proxy(this.mapDetailData,this),error:jQuery.proxy(this.onError,this)})},mapDetailData:function(e,t){var o=new a(e);this.getView().setModel(o,"detail");sap.ui.core.BusyIndicator.hide()},onError:function(e){sap.ui.core.BusyIndicator.hide()},onListItemPress:function(e){var o=e.getSource();var s=sap.ui.core.UIComponent.getRouterFor(this);var a=false;var r=e.getSource().getBindingContext().getPath(),i=r.split("/").slice(-1).pop(),n=this._orden,d=e.getSource().getBindingContext().getModel().getData().lstItemsOperaciones[i].IdOperacion;if(sap.ui.core.routing.History.getInstance().getPreviousHash()){a=true}s.navTo("detailDetail",{layout:t.LayoutType.ThreeColumnsMidExpanded,orden:n,operacion:d},{},a)},onSupplierPress:function(e){var o=e.getSource().getBindingContext("products").getPath(),s=o.split("/").slice(-1).pop();this.oRouter.navTo("detailDetail",{layout:t.LayoutType.ThreeColumnsMidExpanded,supplier:s,product:this._product})},onEditToggleButtonPress:function(){var e=this.getView().byId("ObjectPageLayout"),t=e.getShowFooter();e.setShowFooter(!t)},onPressCaptureQR:function(e){try{var t=this;o.scan(function(e){var o=t.getView().byId("txtEquipo").getText();if(e.text===o){sap.m.MessageBox.show("Equipo:"+e.text+" escaneado correctamente");t.getView().getModel("Qr").setProperty("/Qr",true);t.idEquipo=e.text;var s=t.byId("btnCerrarOperaciones")}else{sap.m.MessageBox.show("El Equipo escaneado:"+e.text+" no concuerda con el Equipo de la Orden: "+o)}},function(e){sap.m.MessageBox.show("Scanning failed: ",e,"")})}catch(e){sap.m.MessageBox.show("Cordova plugin is not available.","")}},onExit:function(){this.oRouter.getRoute("master").detachPatternMatched(this._onProductMatched,this);this.oRouter.getRoute("detail").detachPatternMatched(this._onProductMatched,this)}})});